<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stamp Rally - Detection</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; text-align: center; }
    #video { width: 100%; max-width: 400px; border: 1px solid #ccc; }
    #gpsStatus, #qrStatus { margin-top: 20px; }
    .button { padding: 10px 20px; margin: 10px; font-size: 1em; cursor: pointer; }
    .error { color: red; margin-top: 20px; }
  </style>
  <!-- jsQR library from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
</head>
<body>
  <h1>Location Detection</h1>
  <div id="detectionContent"></div>
  <button class="button" onclick="cancel()">Cancel</button>

  <script>
    const locations = [
      {id: 1, lat: 35.0001, lng: 139.0001, allowance: 0.001},
      /* ... up to id:12 ... */
      {id: 12, lat: 35.0012, lng: 139.0012, allowance: 0.001}
    ];

    function getURLParameter(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    function cancel() {
      // stop any camera if running
      if (window.currentStream) {
        window.currentStream.getTracks().forEach(t => t.stop());
      }
      window.location.href = 'stamp.html';
    }

    const method = getURLParameter('method');
    const content = document.getElementById('detectionContent');

    if (method === 'qr') {
      startQRScan();
    } else if (method === 'gps') {
      startGPS();
    } else {
      content.textContent = 'Error: Unknown detection method.';
    }

    // --- QR code scanning ---
    function startQRScan() {
      content.innerHTML = '<p>Point your camera at the QR code.</p><video id="video" autoplay></video><div id="qrStatus"></div>';
      const video = document.getElementById('video');
      const qrStatus = document.getElementById('qrStatus');
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(stream => {
          window.currentStream = stream;
          video.srcObject = stream;
          video.play();
          requestAnimationFrame(tick);
        })
        .catch(err => qrStatus.innerHTML = `<span class="error">Camera error: ${err.message}</span>`);

      function tick() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
          if (code) {
            const val = code.data.trim();
            const n = parseInt(val, 10);
            if (!isNaN(n) && (1 <= n && n <= 13)) {
              qrStatus.textContent = `Detected QR: ${val}`;
              stopStreamAndRedirect(n);
              return;
            } else {
              qrStatus.innerHTML = `<span class="error">Unrecognized code: ${val}</span>`;
            }
          }
        }
        requestAnimationFrame(tick);
      }
    }

    function stopStreamAndRedirect(n) {
      if (window.currentStream) {
        window.currentStream.getTracks().forEach(t => t.stop());
      }
      setTimeout(() => {
        window.location.href = `stamp.html?stamp=${n}`;
      }, 500);
    }

    // --- GPS detection ---
    function startGPS() {
      content.innerHTML = '<p>Detecting your location…</p><div id="gpsStatus"></div>';
      const gpsStatus = document.getElementById('gpsStatus');
      if (!navigator.geolocation) {
        gpsStatus.textContent = 'Geolocation not supported.';
        return;
      }
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude: userLat, longitude: userLng } = pos.coords;
        gpsStatus.innerHTML = `Latitude: ${userLat.toFixed(6)}<br>Longitude: ${userLng.toFixed(6)}<br><br>`;
        let found = false, id;
        for (const loc of locations) {
          if (Math.abs(userLat - loc.lat) <= loc.allowance && Math.abs(userLng - loc.lng) <= loc.allowance) {
            found = true; id = loc.id; break;
          }
        }
        if (found) {
          gpsStatus.innerHTML += `Detected stamp ${id}! Redirecting…`;
          setTimeout(() => window.location.href = `stamp.html?stamp=${id}`, 1000);
        } else {
          gpsStatus.innerHTML += `<span class="error">Out of designated areas.</span>`;
        }
      }, err => {
        gpsStatus.innerHTML = `<span class="error">Error: ${err.message}</span>`;
      });
    }
  </script>
</body>
</html>
